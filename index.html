<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ophthalmology Visit Scheduler | حاسبة مواعيد العيون</title>
  <meta name="description" content="Compute the next ophthalmology visit based on condition, age, and last visit date. Arabic/English." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Tajawal","system-ui","-apple-system","Segoe UI","Roboto","Arial"] }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; }
    .card { @apply bg-white/80 backdrop-blur shadow-lg rounded-2xl border border-gray-200; }
    .chip { @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50 to-indigo-50 text-slate-800">
  <header class="max-w-4xl mx-auto px-4 pt-8">
    <div class="flex items-center justify-between gap-4">
      <h1 id="title" class="text-2xl md:text-3xl font-bold">حاسبة مواعيد زيارة طبيب العيون</h1>
      <div class="flex items-center gap-2">
        <button id="lang-ar" class="chip border-slate-300 bg-white font-medium" aria-pressed="true">العربية</button>
        <button id="lang-en" class="chip border-slate-300 bg-white">English</button>
      </div>
    </div>
    <p id="subtitle" class="mt-2 text-slate-600">اختر الحالات، أدخل عمرك وتاريخ آخر زيارة، وسنحسب لك أقرب موعد موصى به.</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="card p-5 md:p-6">
      <form id="schedulerForm" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label for="dob" id="lblDob" class="block text-sm font-medium">تاريخ الميلاد</label>
            <input id="dob" name="dob" type="date" class="w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" />
            <p id="helpDob" class="text-xs text-slate-500">يُستخدم لحساب الفئة العمرية.</p>
          </div>
          <div class="space-y-2">
            <label for="lastVisit" id="lblLastVisit" class="block text-sm font-medium">تاريخ آخر زيارة لطبيب العيون</label>
            <input id="lastVisit" name="lastVisit" type="date" required class="w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" />
            <p id="helpLastVisit" class="text-xs text-slate-500">مثال: 2024-12-05 (صيغة التقويم القياسية).</p>
          </div>
        </div>

        <div>
          <h2 id="condHeader" class="text-lg font-semibold mb-2">اختر الحالات/الظروف لديك</h2>
          <p id="condHelper" class="text-sm text-slate-600 mb-3">يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.</p>
          <div class="grid md:grid-cols-2 gap-3" id="conditionsGrid"></div>
        </div>

        <div id="conditionalFields" class="space-y-4 hidden">
          <h3 id="extraHeader" class="font-medium">معلومات إضافية مطلوبة لبعض الحالات</h3>
          <div id="extra-hcq" class="hidden">
            <label id="lblHcqYears" class="block text-sm font-medium mb-1" for="hcqYears">سنوات استخدام هيدروكسي كلوروكين/كلوروكين</label>
            <input id="hcqYears" type="number" min="0" step="1" class="w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="6" />
            <p id="helpHcq" class="text-xs text-slate-500 mt-1">فحص سنوي بعد 5 سنوات من الاستخدام.</p>
          </div>
          <div id="extra-tamox" class="hidden">
            <label id="lblTamoxYears" class="block text-sm font-medium mb-1" for="tamoxYears">سنوات استخدام تاموكسيفين</label>
            <input id="tamoxYears" type="number" min="0" step="1" class="w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="3" />
            <div class="mt-2 flex items-center gap-2">
              <input id="tamoxHighDose" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTamoxHighDose" for="tamoxHighDose" class="text-sm">جرعة مرتفعة</label>
            </div>
            <p id="helpTamox" class="text-xs text-slate-500 mt-1">فحص سنوي إذا المدة &gt; 5 سنوات أو الجرعة مرتفعة.</p>
          </div>
          <div id="extra-ted" class="hidden">
            <div class="flex items-center gap-2">
              <input id="tedActive" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTedActive" for="tedActive" class="text-sm">نشِط حاليًا (مرض عين درقي)</label>
            </div>
            <p id="helpTed" class="text-xs text-slate-500 mt-1">نشِط: كل 3–6 أشهر. مستقر: سنوي.</p>
          </div>
          <div id="extra-t1dm" class="hidden">
            <label id="lblT1Years" class="block text-sm font-medium mb-1" for="t1Years">سنوات منذ تشخيص سكري النوع الأول</label>
            <input id="t1Years" type="number" min="0" step="1" class="w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="4" />
            <p id="helpT1" class="text-xs text-slate-500 mt-1">يبدأ الفحص بعد 5 سنوات من التشخيص، ثم سنويًا.</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-2">
          <button type="submit" id="btnCalc" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">احسب الزيارة القادمة</button>
          <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50">إعادة ضبط</button>
          <button type="button" id="printBtn" class="ml-auto px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50">طباعة/حفظ PDF</button>
        </div>
      </form>
    </section>

    <section id="resultsCard" class="card p-5 md:p-6 mt-6 hidden">
      <h2 id="resultsTitle" class="text-xl font-semibold">النتيجة</h2>
      <div id="summary" class="mt-2 text-slate-700"></div>
      <div id="details" class="mt-4 space-y-3"></div>
      <div id="disclaimer" class="mt-4 p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-800 text-sm">
        تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.
      </div>
    </section>

    <footer class="max-w-4xl mx-auto px-1 mt-10 mb-8 text-xs text-slate-500">
      <p id="footerText">تم عمل هذا الموقع من قبل سلطان الحسن، طبيب امتياز</p>
    </footer>
  </main>

  <script>
    // ===== i18n =====
    const TR = {
      ar: {
        title: "حاسبة مواعيد زيارة طبيب العيون",
        subtitle: "اختر الحالات، أدخل عمرك وتاريخ آخر زيارة، وسنحسب لك أقرب موعد موصى به.",
        dob: "تاريخ الميلاد",
        helpDob: "يُستخدم لحساب الفئة العمرية.",
        lastVisit: "تاريخ آخر زيارة لطبيب العيون",
        helpLastVisit: "مثال: 2024-12-05 (صيغة التقويم القياسية).",
        condHeader: "اختر الحالات/الظروف لديك",
        condHelper: "يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.",
        extraHeader: "معلومات إضافية مطلوبة لبعض الحالات",
        hcqYears: "سنوات استخدام هيدروكسي كلوروكين/كلوروكين",
        helpHcq: "فحص سنوي بعد 5 سنوات من الاستخدام.",
        tamoxYears: "سنوات استخدام تاموكسيفين",
        tamoxHighDose: "جرعة مرتفعة",
        helpTamox: "فحص سنوي إذا المدة > 5 سنوات أو الجرعة مرتفعة.",
        tedActive: "نشِط حاليًا (مرض عين درقي)",
        helpTed: "نشِط: كل 3–6 أشهر. مستقر: سنوي.",
        t1Years: "سنوات منذ تشخيص سكري النوع الأول",
        helpT1: "يبدأ الفحص بعد 5 سنوات من التشخيص، ثم سنويًا.",
        btnCalc: "احسب الزيارة القادمة",
        btnReset: "إعادة ضبط",
        btnPrint: "طباعة/حفظ PDF",
        resultsTitle: "النتيجة",
        lastVisitShort: "تاريخ آخر زيارة",
        age: "العمر",
        earliest: "أقرب موعد موصى به",
        noneAuto: "لا يوجد تاريخ محدد تلقائيًا — راجع التفاصيل.",
        basis: "الأساس",
        nextVisit: "الزيارة القادمة",
        window: "نافذة المتابعة",
        notes: "ملاحظات",
        disclaimer: "تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.",
        footer: "تم عمل هذا الموقع من قبل سلطان الحسن، طبيب امتياز",
        adultsEnterDOB: "للبالغين بدون عوامل خطورة: الرجاء إدخال تاريخ الميلاد.",
        adultsUnder40: "بدون عوامل خطورة: الفحص الشامل عند عمر 40 سنة.",
        // Condition labels
        conds: {
          noRiskAdults: "بالغون بدون عوامل خطورة معروفة",
          healthyChildren: "أطفال أصحاء (فحوصات نظر روتينية أولية)",
          t1dm: "السكري النوع الأول (بالغون)",
          t2dm: "السكري النوع الثاني (بالغون)",
          dmPregnancy: "حمل مع سكري قائم (نوع 1 أو 2)",
          gdm: "سكري حملي",
          glauSuspect: "مشتبه ماء أزرق / ارتفاع ضغط العين",
          fhGlaucoma: "قرابة درجة أولى لمريض ماء أزرق (بدون اشتباه)",
          highMyopia: "قصر نظر شديد (≤ −6.0 D أو طول محوري > 26 مم)",
          hcq: "هيدروكسي كلوروكوين / كلوروكوين",
          tamox: "تاموكسيفين",
          ted: "مرض عين درقي (غريفز)"
        },
        // Explanations per type
        explain: {
          ageRange: "40–54 سنة: كل 2–4 سنوات • 55–64: كل 1–3 سنوات • ≥65: كل 1–2 سنة",
          text: "لا حاجة لزيارة طبيب العيون إذا كانت فحوصات النظر الأولية طبيعية.",
          t1dm: "ابدأ بعد 5 سنوات من التشخيص، ثم سنويًا.",
          annual: "فحص سنوي.",
          pregnancyDM: "قبل الحمل والثلث الأول ثم كل ثلث؛ ما بعد الولادة حسب الطبيب.",
          gdm: "لا يلزم فحص اعتلال الشبكية أثناء الحمل؛ استأنف الجدول العمري بعد الولادة.",
          hcq: "فحص أساسي خلال سنة؛ سنوي بعد 5 سنوات من الاستخدام.",
          tamox: "أساسي في السنة الأولى؛ سنوي إذا >5 سنوات أو جرعات عالية؛ وإلا الجدول العمري.",
          thyroidEye: "كل 3–6 أشهر أثناء النشاط؛ سنوي بعد الاستقرار/اليوثيرويد."
        }
      },
      en: {
        title: "Ophthalmology Visit Scheduler",
        subtitle: "Select your conditions, enter age and last visit date, and we’ll compute the next recommended eye exam.",
        dob: "Date of birth",
        helpDob: "Used to determine age group.",
        lastVisit: "Last ophthalmology visit date",
        helpLastVisit: "Example: 2024-12-05 (standard YYYY-MM-DD).",
        condHeader: "Select your conditions",
        condHelper: "You can choose multiple; we’ll suggest the earliest due date.",
        extraHeader: "Additional info required for some conditions",
        hcqYears: "Years of hydroxychloroquine/chloroquine use",
        helpHcq: "Annual screening after 5 years of use.",
        tamoxYears: "Years of tamoxifen use",
        tamoxHighDose: "High dose",
        helpTamox: "Annual if >5 years or high dose.",
        tedActive: "Currently active (thyroid eye disease)",
        helpTed: "Active: every 3–6 months. Stable: annually.",
        t1Years: "Years since type 1 diabetes diagnosis",
        helpT1: "Begin 5 years after diagnosis, then annually.",
        btnCalc: "Calculate next visit",
        btnReset: "Reset",
        btnPrint: "Print / Save PDF",
        resultsTitle: "Result",
        lastVisitShort: "Last visit",
        age: "Age",
        earliest: "Earliest recommended",
        noneAuto: "No automatic date — see details below.",
        basis: "Basis",
        nextVisit: "Next visit",
        window: "Follow-up window",
        notes: "Notes",
        disclaimer: "Note: Educational tool; not a substitute for medical care.",
        footer: "This site was made by Sultan Alhassan, Medical Intern",
        adultsEnterDOB: "For adults without risk factors: enter date of birth.",
        adultsUnder40: "Without risk factors: comprehensive eye exam at age 40.",
        conds: {
          noRiskAdults: "Adults without known risk factors",
          healthyChildren: "Healthy children (primary vision screening)",
          t1dm: "Type 1 diabetes (adults)",
          t2dm: "Type 2 diabetes (adults)",
          dmPregnancy: "Pregnancy with pre‑existing diabetes (T1/T2)",
          gdm: "Gestational diabetes",
          glauSuspect: "Glaucoma suspect / ocular hypertension",
          fhGlaucoma: "First‑degree relative of a glaucoma patient (no personal suspicion)",
          highMyopia: "High myopia (≤ −6.0 D or axial length > 26 mm)",
          hcq: "Hydroxychloroquine / chloroquine",
          tamox: "Tamoxifen",
          ted: "Thyroid eye disease (Graves)"
        },
        explain: {
          ageRange: "40–54 yrs: every 2–4 yrs • 55–64: every 1–3 yrs • ≥65: every 1–2 yrs",
          text: "No routine ophthalmology visit is needed if primary vision screening is normal.",
          t1dm: "Begin 5 years after diagnosis, then annually.",
          annual: "Annual (every year).",
          pregnancyDM: "Before conception and first trimester; each trimester; postpartum per clinician.",
          gdm: "No retinopathy exam during pregnancy; resume age‑based routine after delivery.",
          hcq: "Baseline within first year; annually after 5 years of use.",
          tamox: "Baseline in year 1; annual if >5 years or high dose; otherwise age‑based routine.",
          thyroidEye: "Every 3–6 months while active; annually when stable/euthyroid."
        }
      }
    };

    // ===== Conditions meta (logic types) =====
    const CONDITIONS = [
      { id: 'noRiskAdults', type: 'ageRange' },
      { id: 'healthyChildren', type: 'text' },
      { id: 't1dm', type: 't1dm' },
      { id: 't2dm', type: 'annual' },
      { id: 'dmPregnancy', type: 'pregnancyDM' },
      { id: 'gdm', type: 'gdm' },
      { id: 'glauSuspect', type: 'annual' },
      { id: 'fhGlaucoma', type: 'annual' },
      { id: 'highMyopia', type: 'annual' },
      { id: 'hcq', type: 'hcq' },
      { id: 'tamox', type: 'tamox' },
      { id: 'ted', type: 'thyroidEye' },
    ];

    // ===== Utils =====
    function addYears(d, n){ const x=new Date(d); x.setFullYear(x.getFullYear()+n); return x; }
    function addMonths(d, n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
    function fmt(date){ if(!(date instanceof Date) || isNaN(date)) return '—'; const d=String(date.getDate()).padStart(2,'0'); const m=String(date.getMonth()+1).padStart(2,'0'); const y=date.getFullYear(); return `${d}/${m}/${y}`; }
    function calcAgeYears(dob){ if(!dob) return null; const today=new Date(); let age=today.getFullYear()-dob.getFullYear(); const m=today.getMonth()-dob.getMonth(); if(m<0||(m===0&&today.getDate()<dob.getDate())) age--; return age; }

    let currentLang = 'ar';

    function t(path){
      const obj = TR[currentLang];
      return path.split('.').reduce((o,k)=> (o||{})[k], obj) || '';
    }

    // Build checklist per language
    const grid = document.getElementById('conditionsGrid');
    function buildConditions(){
      grid.innerHTML = '';
      CONDITIONS.forEach(c => {
        const id = `cond-${c.id}`;
        const el = document.createElement('label');
        el.className = 'flex items-start gap-3 p-3 border rounded-xl bg-white hover:bg-slate-50 cursor-pointer';
        el.innerHTML = `
          <input id="${id}" type="checkbox" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
          <div>
            <div class="font-medium">${t(`conds.${c.id}`)}</div>
            <div class="text-xs text-slate-500">${t(`explain.${c.type}`)}</div>
          </div>`;
        grid.appendChild(el);
      });
    }

    function setLang(lang){
      currentLang = lang;
      document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      // Header
      document.getElementById('title').textContent = t('title');
      document.getElementById('subtitle').textContent = t('subtitle');
      // Labels
      document.getElementById('lblDob').textContent = t('dob');
      document.getElementById('helpDob').textContent = t('helpDob');
      document.getElementById('lblLastVisit').textContent = t('lastVisit');
      document.getElementById('helpLastVisit').textContent = t('helpLastVisit');
      document.getElementById('condHeader').textContent = t('condHeader');
      document.getElementById('condHelper').textContent = t('condHelper');
      document.getElementById('extraHeader').textContent = t('extraHeader');
      document.getElementById('lblHcqYears').textContent = t('hcqYears');
      document.getElementById('helpHcq').textContent = t('helpHcq');
      document.getElementById('lblTamoxYears').textContent = t('tamoxYears');
      document.getElementById('lblTamoxHighDose').textContent = t('tamoxHighDose');
      document.getElementById('helpTamox').textContent = t('helpTamox');
      document.getElementById('lblTedActive').textContent = t('tedActive');
      document.getElementById('helpTed').textContent = t('helpTed');
      document.getElementById('lblT1Years').textContent = t('t1Years');
      document.getElementById('helpT1').textContent = t('helpT1');
      document.getElementById('btnCalc').textContent = t('btnCalc');
      document.getElementById('resetBtn').textContent = t('btnReset');
      document.getElementById('printBtn').textContent = t('btnPrint');
      document.getElementById('resultsTitle').textContent = t('resultsTitle');
      document.getElementById('disclaimer').textContent = t('disclaimer');
      document.getElementById('footerText').textContent = t('footer');
      // Chips pressed states
      document.getElementById('lang-ar').setAttribute('aria-pressed', lang==='ar');
      document.getElementById('lang-en').setAttribute('aria-pressed', lang==='en');
      buildConditions();
    }

    // First render
    buildConditions();

    // Conditional fields toggling
    function sel(key){ return document.getElementById(`cond-${key}`)?.checked; }
    const toggleExtra = () => {
      const any = sel('hcq') || sel('tamox') || sel('ted') || sel('t1dm');
      document.getElementById('conditionalFields').classList.toggle('hidden', !any);
      document.getElementById('extra-hcq').classList.toggle('hidden', !sel('hcq'));
      document.getElementById('extra-tamox').classList.toggle('hidden', !sel('tamox'));
      document.getElementById('extra-ted').classList.toggle('hidden', !sel('ted'));
      document.getElementById('extra-t1dm').classList.toggle('hidden', !sel('t1dm'));
    };
    grid.addEventListener('change', toggleExtra);

    // Reset & Print
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('schedulerForm').reset();
      document.getElementById('conditionalFields').classList.add('hidden');
      document.getElementById('resultsCard').classList.add('hidden');
      buildConditions();
    });
    document.getElementById('printBtn').addEventListener('click', () => window.print());

    // Submit handler
    document.getElementById('schedulerForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const lastVisitStr = document.getElementById('lastVisit').value;
      if(!lastVisitStr){ alert(currentLang==='ar'?'أدخل تاريخ آخر زيارة.':'Enter the last visit date.'); return; }
      const lastVisit = new Date(lastVisitStr);
      const dobStr = document.getElementById('dob').value;
      const dob = dobStr ? new Date(dobStr) : null;
      const ageYears = dob ? calcAgeYears(dob) : null;

      const selected = CONDITIONS.filter(c => document.getElementById(`cond-${c.id}`).checked)
                                 .map(c => ({...c, label: t(`conds.${c.id}`)}));
      if(selected.length === 0){ showOnlyGeneral(ageYears, lastVisit); return; }

      const extras = {
        hcqYears: parseInt(document.getElementById('hcqYears')?.value || '0', 10),
        tamoxYears: parseInt(document.getElementById('tamoxYears')?.value || '0', 10),
        tamoxHighDose: !!document.getElementById('tamoxHighDose')?.checked,
        tedActive: !!document.getElementById('tedActive')?.checked,
        t1Years: parseInt(document.getElementById('t1Years')?.value || '0', 10),
      };

      const recommendations = [];
      const notes = [];

      selected.forEach(c => {
        switch(c.type){
          case 'annual': {
            const next = addYears(lastVisit, 1);
            recommendations.push({ id:c.id, label:c.label, nextDate: next, window: null, basis:t('explain.annual') });
            break;
          }
          case 'ageRange': {
            if (ageYears == null){
              notes.push(t('adultsEnterDOB'));
            } else if (ageYears < 40) {
              notes.push(t('adultsUnder40'));
            } else if (ageYears >= 40 && ageYears <= 54) {
              recommendations.push({ id:c.id, label:c.label, nextDate: addYears(lastVisit, 2), window: [addYears(lastVisit,2), addYears(lastVisit,4)], basis:t('explain.ageRange') + (currentLang==='ar'? ' (40–54)': ' (40–54)') });
            } else if (ageYears >= 55 && ageYears <= 64) {
              recommendations.push({ id:c.id, label:c.label, nextDate: addYears(lastVisit, 1), window: [addYears(lastVisit,1), addYears(lastVisit,3)], basis:t('explain.ageRange') + (currentLang==='ar'? ' (55–64)': ' (55–64)') });
            } else { // >=65
              recommendations.push({ id:c.id, label:c.label, nextDate: addYears(lastVisit, 1), window: [addYears(lastVisit,1), addYears(lastVisit,2)], basis:t('explain.ageRange') + (currentLang==='ar'? ' (≥65)': ' (≥65)') });
            }
            break;
          }
          case 'text': {
            notes.push(t('explain.text'));
            break;
          }
          case 't1dm': {
            if (isFinite(extras.t1Years)){
              if (extras.t1Years < 5){
                notes.push(currentLang==='ar' ? 'سكري نوع أول: يبدأ فحص الشبكية بعد 5 سنوات من التشخيص (أو الآن إذا لم تُفحص سابقًا)، ثم سنويًا.' : 'Type 1 DM: start retinal screening 5 years after diagnosis (or now if never screened), then annually.');
              }
            }
            const next = addYears(lastVisit, 1);
            recommendations.push({ id:c.id, label:c.label, nextDate: next, window: null, basis: currentLang==='ar' ? 'سنوي بعد بدء المتابعة' : 'Annual once follow‑up starts' });
            break;
          }
          case 'pregnancyDM': {
            notes.push(t('explain.pregnancyDM'));
            break;
          }
          case 'gdm': {
            notes.push(t('explain.gdm'));
            break;
          }
          case 'hcq': {
            if (extras.hcqYears >= 5){
              const next = addYears(lastVisit, 1);
              recommendations.push({ id:c.id, label:c.label, nextDate: next, window: null, basis: currentLang==='ar'?'سنوي بعد 5 سنوات من الاستخدام':'Annual after 5 years of use' });
            } else {
              notes.push(currentLang==='ar' ? 'استخدام HCQ/كوروكين أقل من 5 سنوات: اتبع الجدول العمري؛ قد يلزم أبكر إذا مرتفع الخطورة.' : 'HCQ/chloroquine <5 years: follow age‑based routine; earlier if high risk.');
            }
            break;
          }
          case 'tamox': {
            if (extras.tamoxHighDose || extras.tamoxYears > 5){
              const next = addYears(lastVisit, 1);
              recommendations.push({ id:c.id, label:c.label, nextDate: next, window: null, basis: currentLang==='ar'?'سنوي (>5 سنوات أو جرعات مرتفعة)':'Annual (>5 years or high dose)' });
            } else {
              notes.push(currentLang==='ar' ? 'تاموكسيفين ≤ 5 سنوات وبدون جرعات مرتفعة: اتبع الجدول العمري.' : 'Tamoxifen ≤5 years and not high dose: follow age‑based routine.');
            }
            break;
          }
          case 'thyroidEye': {
            if (extras.tedActive){
              const early = addMonths(lastVisit, 3);
              const late  = addMonths(lastVisit, 6);
              recommendations.push({ id:c.id, label:c.label, nextDate: early, window:[early, late], basis: currentLang==='ar'?'كل 3–6 أشهر أثناء النشاط':'Every 3–6 months while active' });
            } else {
              const next = addYears(lastVisit, 1);
              recommendations.push({ id:c.id, label:c.label, nextDate: next, window:null, basis: currentLang==='ar'?'سنوي بعد الاستقرار':'Annual when stable' });
            }
            break;
          }
        }
      });

      const dated = recommendations.filter(r => r.nextDate instanceof Date && !isNaN(r.nextDate));
      const earliest = dated.length ? dated.reduce((a,b)=> a.nextDate < b.nextDate ? a : b) : null;

      const resultsCard = document.getElementById('resultsCard');
      const summary = document.getElementById('summary');
      const details = document.getElementById('details');
      resultsCard.classList.remove('hidden');

      let s = '';
      s += `<div class="text-sm text-slate-600">${t('lastVisitShort')}: <span class="font-medium">${fmt(lastVisit)}</span>${ageYears!=null?` • ${t('age')}: <span class="font-medium">${ageYears}</span>`:''}</div>`;

      if (earliest){
        s += `<div class="mt-2 text-lg">${t('earliest')}: <span class="font-semibold">${fmt(earliest.nextDate)}</span></div>`;
      } else {
        s += `<div class="mt-2 text-lg">${t('noneAuto')}</div>`;
      }
      summary.innerHTML = s;

      details.innerHTML = '';
      dated.forEach(r => {
        const row = document.createElement('div');
        row.className = 'p-3 border rounded-xl bg-white';
        const windowTxt = r.window ? `${t('window')}: ${fmt(r.window[0])} → ${fmt(r.window[1])}` : '';
        row.innerHTML = `<div class="font-medium">${r.label}</div>
          <div class="text-sm text-slate-700">${t('basis')}: ${r.basis}</div>
          <div class="text-sm">${t('nextVisit')}: <span class="font-semibold">${fmt(r.nextDate)}</span>${windowTxt?`<div class='text-xs text-slate-600 mt-1'>${windowTxt}</div>`:''}</div>`;
        details.appendChild(row);
      });

      if (notes.length){
        const n = document.createElement('div');
        n.className = 'p-3 border rounded-xl bg-white';
        n.innerHTML = `<div class="font-medium mb-1">${t('notes')}</div><ul class="list-disc pr-5 space-y-1 text-sm">${notes.map(x=>`<li>${x}</li>`).join('')}</ul>`;
        details.appendChild(n);
      }

      resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    function showOnlyGeneral(ageYears, lastVisit){
      const resultsCard = document.getElementById('resultsCard');
      const summary = document.getElementById('summary');
      const details = document.getElementById('details');
      resultsCard.classList.remove('hidden');
      let s = `<div class="text-sm text-slate-600">${t('lastVisitShort')}: <span class=\"font-medium\">${fmt(lastVisit)}</span>${ageYears!=null?` • ${t('age')}: <span class=\"font-medium\">${ageYears}</span>`:''}</div>`;
      let blocks = '';

      if (ageYears == null){
        s += `<div class="mt-2 text-lg">${t('adultsEnterDOB')}</div>`;
      } else if (ageYears < 40){
        s += `<div class="mt-2">${t('adultsUnder40')}</div>`;
      } else if (ageYears <= 54){
        s += `<div class="mt-2 text-lg">${t('window')}: <span class="font-semibold">${fmt(addYears(lastVisit,2))}</span> → <span class="font-semibold">${fmt(addYears(lastVisit,4))}</span></div>`;
        blocks += block(t('conds.noRiskAdults') + (currentLang==='ar'?' (40–54)':' (40–54)'), t('explain.ageRange'), addYears(lastVisit,2), [addYears(lastVisit,2), addYears(lastVisit,4)]);
      } else if (ageYears <= 64){
        s += `<div class="mt-2 text-lg">${t('window')}: <span class="font-semibold">${fmt(addYears(lastVisit,1))}</span> → <span class="font-semibold">${fmt(addYears(lastVisit,3))}</span></div>`;
        blocks += block(t('conds.noRiskAdults') + (currentLang==='ar'?' (55–64)':' (55–64)'), t('explain.ageRange'), addYears(lastVisit,1), [addYears(lastVisit,1), addYears(lastVisit,3)]);
      } else {
        s += `<div class="mt-2 text-lg">${t('window')}: <span class="font-semibold">${fmt(addYears(lastVisit,1))}</span> → <span class="font-semibold">${fmt(addYears(lastVisit,2))}</span></div>`;
        blocks += block(t('conds.noRiskAdults') + ' (≥65)', t('explain.ageRange'), addYears(lastVisit,1), [addYears(lastVisit,1), addYears(lastVisit,2)]);
      }

      summary.innerHTML = s;
      details.innerHTML = blocks;
      resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function block(title, basis, nextDate, window){
      const windowTxt = window ? `${t('window')}: ${fmt(window[0])} → ${fmt(window[1])}` : '';
      return `<div class="p-3 border rounded-xl bg-white">
        <div class="font-medium">${title}</div>
        <div class="text-sm text-slate-700">${t('basis')}: ${basis}</div>
        <div class="text-sm">${t('nextVisit')}: <span class="font-semibold">${fmt(nextDate)}</span>${window?`<div class='text-xs text-slate-600 mt-1'>${windowTxt}</div>`:''}</div>
      </div>`;
    }

    // Language toggle
    document.getElementById('lang-ar').addEventListener('click', () => setLang('ar'));
    document.getElementById('lang-en').addEventListener('click', () => setLang('en'));

    // Initialize AR by default
    setLang('ar');
  </script>
</body>
</html>
